var onceUpon=angular.module("onceUpon",["ui.router","ngAnimate"]);onceUpon.constant("Modernizr",Modernizr),onceUpon.config(["$stateProvider","$urlRouterProvider",function(e,n){e.state("home",{url:"",views:{status:{templateUrl:"partials/status.html",controller:"StatusCtrl"},sentences:{templateUrl:"partials/sentences.html",controller:"SentencesCtrl"},record:{templateUrl:"partials/record.html",controller:"RecordCtrl"}},resolve:{sentencePromise:["SentencesFactory",function(e){return e.getAll()}]}})}]),onceUpon.factory("PlaybackFactory",["$rootScope","SentencesFactory",function(e,n){var t={};return t.sentenceIds,t.playing=null,t.audio=$("audio#playback"),e.$watch(function(){return n.sentences},function(e,n){t.sentenceIds=e.map(function(e){return e._id})}),t.init=function(){t.audio[0].addEventListener("ended",function(){$("li.sentence#"+t.playing).removeClass("playing");var n=t.sentenceIds[t.sentenceIds.indexOf(t.playing)+1];if(n){if(t.playAudio(n),!t.sentenceIsVisible(n)){var o=$("li.sentence#"+n);$("#sentences-panel").animate({scrollTop:o[0].offsetTop-15},300)}}else t.playing=null;e.$apply()})},t.playAudio=function(e){t.stopAll(),t.audio[0].src="getRecording/"+e,t.audio[0].load(),t.audio[0].play(),$("li.sentence#"+e).addClass("playing"),t.playing=e},t.playFromBeginning=function(){t.playAudio(t.sentenceIds[0]),$("#sentences-panel").animate({scrollTop:0},500)},t.stopAll=function(){t.playing&&(t.audio[0].pause(),t.audio[0].currentTime=0,$("li.sentence#"+t.playing).removeClass("playing"),t.playing=null)},t.sentenceIsVisible=function(e){var n=$("li.sentence#"+e),t=$(n).position().top+$(n).height();return t>0&&t<$("#sentences-panel").innerHeight()},t.init(),t}]),onceUpon.factory("SentencesFactory",["$http","$rootScope",function(e,n){var t={},o=new lamejs;return t.sentences=[],t.lastTimestamp=null,t.currentlyPlaying=null,t.saveSentence=function(e,n){e.exportWAV(function(r){e.clear();var i=new FileReader;i.onload=function(e){var r=o.WavHeader.readHeader(new DataView(e.target.result));samples=new Int16Array(e.target.result,r.dataOffset,r.dataLen/2),t.encodeMonoMP3(r.channels,r.sampleRate,samples,n)},i.readAsArrayBuffer(r)})},t.encodeMonoMP3=function(e,n,r,i){var a=[];mp3enc=new o.Mp3Encoder(e,n,192);for(var s=r.length,c=1152,l=0;s>=c;l+=c){var u=r.subarray(l,l+c),g=mp3enc.encodeBuffer(u);g.length>0&&a.push(new Int8Array(g)),s-=c}var d=mp3enc.flush();d.length>0&&a.push(new Int8Array(d));var p=new Blob(a,{type:"audio/mp3"});t.saveMP3ToDB(p,i)},t.saveMP3ToDB=function(n,t){var o=new FileReader;o.onload=function(n){e({method:"POST",url:"saveRecording",data:{audio:n.target.result,text:t,timestamp:(new Date).toISOString()}}).then(function(e){},function(e){console.log("Error saving MP3 file to db: "+e)})},o.readAsDataURL(n)},t.getAll=function(){return e.get("sentences").success(function(e){t.sentences=e,t.sentences.length&&(t.lastTimestamp=t.sentences[t.sentences.length-1].timestamp)})},t.getNew=function(){return t.lastTimestamp?e.get("sentences/new/"+t.lastTimestamp).success(function(e){e.length&&(t.sentences=t.sentences.concat(e),t.lastTimestamp=t.sentences[t.sentences.length-1].timestamp)}):t.getAll()},t}]),onceUpon.factory("SocketFactory",["SentencesFactory","$rootScope","$timeout","Modernizr",function(e,n,t,o){var r,i={};return i.canRecord=o.getusermedia&&o.speechrecognition,i.userPosition=null,i.totalUsers=null,i.remainingTime=null,i.currentMessage={userId:null,inProgress:!1,text:null,uploading:!1},i.countingDown=!1,i.beginRecording=function(){n.$apply(function(){i.countingDown=!1});var e={userId:r.io.engine.id,inProgress:!0,text:null,uploading:!1};r.emit("begin recording",e),i.currentMessage=e},i.updateText=function(e){var n={userId:r.io.engine.id,inProgress:!0,text:e,uploading:!1};r.emit("word",n),i.currentMessage=n},i.endRecording=function(){var e={userId:r.io.engine.id,inProgress:!1,text:null,uploading:!0};r.emit("end recording",e),i.currentMessage=e},i.abortRecording=function(){var e={userId:r.io.engine.id,inProgress:!1,text:null,uploading:!1};r.emit("abort recording",e),i.currentMessage=e},i.countdownToRecord=function(){var e,t=30;i.countingDown=!0;var o=function(){if(!i.countingDown)return t=30,void clearInterval(e);if(n.$apply(function(){i.remainingTime=t}),0===t){n.$apply(function(){i.countingDown=!1});var o={userId:r.io.engine.id,inProgress:!1,text:null,uploading:!1};return r.emit("countdown over",o),void clearInterval(e)}t--};o(),e=setInterval(o,1e3)},angular.element(document).ready(function(){r=io(),r.on("record capability query",function(e){r.emit("record capability response",{canRecord:i.canRecord})}),r.on("status",function(e){0!=e.userPosition||1===e.totalUsers||i.countingDown||i.countdownToRecord(),n.$apply(function(){i.userPosition=e.userPosition,i.totalUsers=e.totalUsers})}),r.on("begin recording",function(e){n.$apply(function(){i.currentMessage.text=null,i.currentMessage.inProgress=!0,i.currentMessage.userId=e.userId})}),r.on("word",function(e){n.$apply(function(){i.currentMessage.text=e.text})}),r.on("end recording",function(e){n.$apply(function(){})}),r.on("abort recording",function(e){n.$apply(function(){i.currentMessage=e})}),r.on("recording saved",function(t){n.$apply(function(){i.currentMessage.inProgress=!1,i.currentMessage.text=null,i.currentMessage.uploading=!1,e.getNew()})})}),i}]),onceUpon.directive("navbarExpand",["$animate","Modernizr",function(e,n){function t(t,o,r){t.recordEnabled=n.getusermedia&&n.speechrecognition;var i=(o.find("#what"),o.find("#how"),null);o.bind("click",function(n){if("what"===n.target.id||"how"===n.target.id){var r=o.find("#navbar-content-"+n.target.id);o.hasClass("expanded")?o.hasClass("expanded")&&i!==n.target&&a(r):e.addClass(o,"expanded").then(a(r))}else o.hasClass("expanded")&&s();n.stopPropagation(),t.$apply()});var a=function(n){i?e.removeClass(i,"showing").then(function(){e.addClass(n,"showing")}):e.addClass(n,"showing"),i=n},s=function(){i&&e.removeClass(i,"showing").then(function(){e.removeClass(o,"expanded"),i=null})}}return{restrict:"A",scope:!0,templateUrl:"partials/navbar.html",link:t}}]),onceUpon.directive("scroller",["$animate","SocketFactory","SentencesFactory",function(e,n,t){function o(e,o,r){e.newEntries=!1,e.$watch(function(){return n.currentMessage.inProgress},function(e,t){e===!0&&(0===n.userPosition?o.animate({scrollTop:o[0].scrollHeight+300},1e3):(console.log("new entries should be pulsing cuz somebody else is talking"),$("#new-entries").addClass("pulsing"))),e===!1&&$("#new-entries").removeClass("pulsing")}),e.$watch(function(){return t.sentences},function(t,o){t.length>o.length&&n.userPosition!==n.totalUsers-1&&($("#new-entries").addClass("visible"),e.newEntries=!0)}),o.bind("scroll",function(){var n=o[0].scrollTop+o.height()+500;n>o[0].scrollHeight&&($("#new-entries").removeClass("visible"),e.newEntries=!1)}),e.scrollToBottom=function(){o.animate({scrollTop:o[0].scrollHeight+300},1e3)}}return{restrict:"A",scope:!0,link:o}}]),onceUpon.directive("recordButton",["$animate","SocketFactory",function(e,n){function t(e,n,t){var o=n.find("img");e.clickable=!1,e.$watchGroup(["SocketFactory.userPosition","SocketFactory.currentMessage"],function(n,t){var r=n[0],i=n[1];0!==r||i.inProgress?0===r&&i.inProgress?(o.removeClass("ready waiting"),o.addClass("active"),e.clickable=!1):(o.removeClass("ready active"),o.addClass("waiting"),e.clickable=!1):(o.removeClass("active waiting"),o.addClass("ready"),e.clickable=!0)})}return{restrict:"A",link:t}}]),onceUpon.controller("RecordCtrl",["$scope","SentencesFactory","SocketFactory","PlaybackFactory","$http","$timeout","Modernizr",function(e,n,t,o,r,i,a){e.SocketFactory=t,e.rec,e.context,e.mediaStreamSource,e.recognition,e.interim,e["final"]=null,e.recognizing=!1,e.timeRemaining=null,e.getButtonClass=function(){return 0!==t.userPosition||e.recognizing?0===t.userPosition&&e.recognizing?"recording":0!==t.userPosition?"waiting":void 0:"ready"},e.start=function(){o.stopAll(),e.startTimer(),e.rec.record(),e.recognition.start()},e.save=function(){e.rec.stop(),e.recognition.stop(),n.saveSentence(e.rec,e.text)},e.startTimer=function(){console.log("timer start, scope.recognizing="+e.recognizing),i(function(){console.log("timer, scope.recognizing:"+e.recognizing+", scope.final= "+e["final"]),e["final"]||(e.recognizing=!1,e.rec.stop(),e.recognition.stop(),t.abortRecording(),e.interim=null,e["final"]=null)},5e3)};var s=function(){"webkitSpeechRecognition"in window?(e.recognition=new webkitSpeechRecognition,e.recognition.interimResults=!0,e.recognition.continuous=!1,e.recognition.lang="en-US",e.recognition.onstart=function(){e.recognizing=!0,t.beginRecording(),e.$apply()},e.recognition.onresult=function(n){var o=n.resultIndex,r=n.results[o][0].transcript;n.results[o].isFinal?(e["final"]=r,e.text=r,e.save(),t.endRecording(),e.interim=null,e["final"]=null,e.$apply()):(e.interim=r,t.updateText(r),e.$apply())},e.recognition.onerror=function(n){console.log("speech recognition error:"+n.error),"not-allowed"===n.error?console.log("Speech recognition not allowed"):console.log("Other speech recognition error"),e.$apply()},e.recognition.onend=function(){e.recognizing=!1,e.$apply()}):console.log("Your browser does not support speech recognition. Please use the latest version of Google Chrome.")},c=function(n){e.context=new(window.AudioContext||window.webkitAudioContext),e.mediaStreamSource=e.context.createMediaStreamSource(n),e.rec=new Recorder(e.mediaStreamSource,{numChannels:1})},l=function(e){console.log("The following getUserMedia error occured: "+e)};angular.element(document).ready(function(){a.getusermedia&&a.speechrecognition&&(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices.getUserMedia,navigator.getUserMedia({audio:!0,video:!1},c,l),s())})}]),onceUpon.controller("SentencesCtrl",["$scope","SentencesFactory","PlaybackFactory","SocketFactory",function(e,n,t,o){e.SentencesFactory=n,e.PlaybackFactory=t,e.SocketFactory=o,e.getCursorClass=function(){return 0===o.userPosition?"blinking-cursor-you":"blinking-cursor-friend"}}]),onceUpon.controller("StatusCtrl",["$scope","SocketFactory",function(e,n){e.SocketFactory=n,e.range=function(e){for(var n=[],t=e-1;t>=0;t--)n.push(t);return n},e.getStatusText=function(e){return 0===e?n.totalUsers>1&&0===n.userPosition?"ready..."+n.remainingTime:1===n.totalUsers&&0===n.userPosition?"ready":"speaking":1===e?"next":"queued"}}]);